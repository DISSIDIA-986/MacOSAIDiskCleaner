# macOS AI Disk Cleaner - å®æ–½å¼€å‘è®¡åˆ’

æœ¬è®¡åˆ’åŸºäº `complete_design_doc_v2.md` å’Œ `quick_reference_guide_v2.md` åˆ¶å®šï¼Œæ—¨åœ¨ç¡®ä¿é¡¹ç›®å®‰å…¨ã€é«˜æ•ˆåœ°è½åœ°ã€‚

---

## ğŸ“… æ€»ä½“æ—¶é—´è¡¨

- **Phase 0: å¼€å‘ç¯å¢ƒå‡†å¤‡ (Day 1-2)**
  - é‡ç‚¹ï¼šHardened Runtimeã€Entitlementsã€Privacy Manifestã€é¡¹ç›®ç»“æ„ã€‚
- **Phase 1: åŸºç¡€æ¶æ„ä¸å®‰å…¨è¾¹ç•Œ (Week 1)**
  - é‡ç‚¹ï¼šéæ²™ç›’å·¥ç¨‹æ­å»ºã€å…¨ç›˜æƒé™å¼•å¯¼ã€å®‰å…¨çš„æ–‡ä»¶æ‰«æå™¨ã€‚
- **Phase 2: æ™ºèƒ½æ ¸å¿ƒä¸è§„åˆ™å¼•æ“ (Week 2)**
  - é‡ç‚¹ï¼šè§„åˆ™å¼•æ“ç§»æ¤ã€Prompt ç®¡ç†ç³»ç»Ÿã€LLM API é›†æˆã€‚
- **Phase 3: æ•´åˆã€å®‰å…¨é˜²æŠ¤ä¸äº¤ä»˜ (Week 3)**
  - é‡ç‚¹ï¼šSparkle æ›´æ–°ã€Dry Run æ¨¡å¼ã€å®¡è®¡æ—¥å¿—ã€CI/CDã€é›†æˆæµ‹è¯•ã€‚

---

## ğŸ› ï¸ Phase 0: å¼€å‘ç¯å¢ƒå‡†å¤‡ (Day 1-2)

**ç›®æ ‡**ï¼šç¡®ä¿å·¥ç¨‹é…ç½®æ»¡è¶³ Apple å…¬è¯å’Œéšç§åˆè§„è¦æ±‚ã€‚

### æ­¥éª¤ 0.1: Hardened Runtime é…ç½®
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   åœ¨ Xcode ä¸­å¯ç”¨ **Hardened Runtime** (Signing & Capabilities)ã€‚
    *   éæ²™ç›’ App å¿…é¡»å¯ç”¨ Hardened Runtime æ‰èƒ½é€šè¿‡å…¬è¯ã€‚
    *   å¦‚éœ€åŠ¨æ€åŠ è½½ä»£ç ï¼Œæ·»åŠ ä¾‹å¤–ï¼š`com.apple.security.cs.allow-unsigned-executable-memory`ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   ä½¿ç”¨ `codesign -dvvv --entitlements - YourApp.app` æ£€æŸ¥ Hardened Runtime æ ‡å¿—ã€‚

### æ­¥éª¤ 0.2: Entitlements æ–‡ä»¶é…ç½®
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   åˆ›å»º `MacOSAIDiskCleaner.entitlements` æ–‡ä»¶ï¼Œæ˜ç¡®å£°æ˜æ‰€éœ€æƒé™ï¼š
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>com.apple.security.automation.apple-events</key>
        <true/>
    </dict>
    </plist>
    ```
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   ç¡®ä¿ Xcode Build Settings ä¸­ Code Signing Entitlements æŒ‡å‘è¯¥æ–‡ä»¶ã€‚

### æ­¥éª¤ 0.3: Privacy Manifest (PrivacyInfo.xcprivacy)
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   macOS 14+ å¼ºåˆ¶è¦æ±‚ Privacy Manifestï¼Œå£°æ˜ API ä½¿ç”¨ç›®çš„ã€‚
    *   åˆ›å»º `PrivacyInfo.xcprivacy` æ–‡ä»¶ï¼Œå£°æ˜æ–‡ä»¶è®¿é—® API ç”¨é€”ï¼š
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>NSPrivacyAccessedAPITypes</key>
        <array>
            <dict>
                <key>NSPrivacyAccessedAPIType</key>
                <string>NSPrivacyAccessedAPICategoryFileTimestamp</string>
                <key>NSPrivacyAccessedAPITypeReasons</key>
                <array>
                    <string>C617.1</string>
                </array>
            </dict>
            <dict>
                <key>NSPrivacyAccessedAPIType</key>
                <string>NSPrivacyAccessedAPICategoryDiskSpace</string>
                <key>NSPrivacyAccessedAPITypeReasons</key>
                <array>
                    <string>E174.1</string>
                </array>
            </dict>
        </array>
    </dict>
    </plist>
    ```
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   åœ¨ Xcode ä¸­ç¡®è®¤ Privacy Manifest å·²æ·»åŠ åˆ° Targetã€‚

### æ­¥éª¤ 0.4: é¡¹ç›®ç»“æ„ä¸é”™è¯¯å¤„ç†æ¡†æ¶
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   å®šä¹‰ç»Ÿä¸€é”™è¯¯ç±»å‹ `DiskCleanerError`ï¼š
    ```swift
    enum DiskCleanerError: LocalizedError {
        case permissionDenied(String)
        case scanCancelled
        case fileInUse(URL)
        case trashFailed(URL, Error)
        case aiRequestFailed(Error)
        case networkUnavailable
        
        var errorDescription: String? { /* ... */ }
    }
    ```
    *   ä½¿ç”¨ `os.Logger` å»ºç«‹æ—¥å¿—ç³»ç»Ÿï¼Œåˆ† subsystem è®°å½•è°ƒè¯•æ—¥å¿—ï¼š
    ```swift
    import os
    let logger = Logger(subsystem: "com.yourcompany.diskcleaner", category: "scanner")
    ```
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   ç¡®ä¿æ‰€æœ‰æ¨¡å—ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç±»å‹å’Œæ—¥å¿—ç³»ç»Ÿã€‚

---

## ğŸš€ Phase 1: åŸºç¡€æ¶æ„ä¸å®‰å…¨è¾¹ç•Œ (Week 1)

**ç›®æ ‡**ï¼šæ„å»ºä¸€ä¸ªèƒ½å®‰å…¨æ‰«æç£ç›˜ã€æ‹¥æœ‰æ­£ç¡®æƒé™çš„ macOS åº”ç”¨éª¨æ¶ã€‚

### æ­¥éª¤ 1.1: å·¥ç¨‹åˆå§‹åŒ–ä¸æƒé™é…ç½®
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   åˆ›å»º Xcode é¡¹ç›® (macOS App, SwiftUI)ã€‚
    *   é…ç½® Target ä¸º **Non-Sandboxed** (ç§»é™¤ App Sandbox entitlement)ã€‚
    *   é…ç½® `Info.plist` æ·»åŠ  `NSAppleEventsUsageDescription` (ä¸ºå¯èƒ½çš„ AppleScript é¢„ç•™)ã€‚
    *   å®ç°å¯åŠ¨æ—¶æ£€æŸ¥ **Full Disk Access** çš„å¼•å¯¼é¡µã€‚
    *   **âš ï¸ é‡è¦**ï¼šFDA æƒé™**æ— æ³•é€šè¿‡ä»£ç è§¦å‘ç³»ç»Ÿå¼¹çª—**ï¼Œåªèƒ½å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨å¼€å¯ã€‚
*   **æƒé™æ£€æµ‹å®ç°**ï¼š
    ```swift
    class PermissionManager {
        /// æ£€æµ‹ FDA æƒé™ï¼ˆé€šè¿‡å°è¯•è®¿é—®å—ä¿æŠ¤ç›®å½•ï¼‰
        func checkFullDiskAccess() -> Bool {
            let testPath = FileManager.default.homeDirectoryForCurrentUser
                .appendingPathComponent("Library/Mail")
            return FileManager.default.isReadableFile(atPath: testPath.path)
        }
        
        /// å¼•å¯¼ç”¨æˆ·æ‰“å¼€ç³»ç»Ÿè®¾ç½®ï¼ˆæ— æ³•è‡ªåŠ¨è¯·æ±‚æƒé™ï¼‰
        func openFDASettings() {
            let url = URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_AllFiles")!
            NSWorkspace.shared.open(url)
        }
    }
    ```
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   å¯åŠ¨ Appï¼Œå°è¯•è®¿é—® `~/Library/Messages` æˆ– `~/Library/Mail`ã€‚
    *   å¦‚æœæœªæˆæƒï¼ŒApp åº”æ˜¾ç¤ºå¼•å¯¼é¡µï¼Œç‚¹å‡»æŒ‰é’®å¯è·³è½¬åˆ°ç³»ç»Ÿè®¾ç½®çš„ FDA é¢æ¿ã€‚
*   **æµ‹è¯•è®¡åˆ’**ï¼š
    *   æ‰‹åŠ¨æµ‹è¯•ï¼šåœ¨æœªæˆæƒçŠ¶æ€ä¸‹å¯åŠ¨ Appï¼Œç¡®ä¿å¼•å¯¼é¡µæ˜¾ç¤ºæ­£å¸¸ä¸”è·³è½¬æŒ‰é’®æœ‰æ•ˆã€‚
    *   æ‰‹åŠ¨æµ‹è¯•ï¼šæˆæƒåé‡å¯ Appï¼Œç¡®ä¿èƒ½åˆ—å‡ºå—ä¿æŠ¤ç›®å½•å†…å®¹ã€‚

### æ­¥éª¤ 1.2: å®‰å…¨æ–‡ä»¶æ‰«æå™¨ (Safe File Scanner)
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   å°è£… `FileScanner` æœåŠ¡ï¼ŒåŸºäº `FileManager` å’Œ `URLResourceKey`ã€‚
    *   **ç›®å½•å¤§å°è®¡ç®—**ï¼šå®ç°é€’å½’ç´¯åŠ é€»è¾‘ï¼ˆAPFS ç›®å½•æœ¬èº«ä¸åŒ…å«å†…å®¹å¤§å°ï¼‰ã€‚åœ¨æ‰«æè¿‡ç¨‹ä¸­æµå¼è®¡ç®—çˆ¶ç›®å½•å¤§å°ï¼Œé¿å…äºŒæ¬¡éå†ã€‚
    *   **æ¯æ¬¡æ‰«æå‰é‡æ–°æ£€æŸ¥ FDA æƒé™**ï¼Œç”¨æˆ·å¯èƒ½éšæ—¶åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æ’¤é”€ã€‚
    *   å®ç° **Symlink é˜²å¾¡**ï¼šæ£€æŸ¥æ–‡ä»¶å±æ€§ï¼Œé‡åˆ° `.symbolicLink` ç±»å‹æ—¶ï¼Œè®°å½•ä½†ä¸é€’å½’è¿›å…¥ã€‚
    *   å®ç° **Cloud å ä½ç¬¦é˜²å¾¡**ï¼š
        *   æ£€æŸ¥ `URLResourceKey.isUbiquitousItemKey` åˆ¤æ–­æ˜¯å¦ä¸º iCloud æ–‡ä»¶ã€‚
        *   æ£€æŸ¥ `URLResourceKey.ubiquitousItemDownloadingStatusKey`ï¼Œåªæœ‰ `downloaded` çŠ¶æ€æ‰è®¡å…¥å¤§å°ã€‚
    *   å®ç° **å®Œæ•´çš„ SIP ä¿æŠ¤åå•**ï¼ˆç¡¬ç¼–ç ç¦æ­¢æ‰«æåŒºåŸŸï¼‰ï¼š
        ```swift
        static let systemProtectedPaths: Set<String> = [
            "/System",
            "/usr",
            "/bin",
            "/sbin",
            "/private/var/db",
            "/Library/Apple",
            "/.Trashes",
            "/.Spotlight-V100",
            "/.fseventsd",
            "/Volumes/.timemachine"  // Time Machine æœ¬åœ°å¿«ç…§
        ]
        ```
    *   å®ç° **Firmlink å»é‡**ï¼šmacOS Catalina+ çš„ `/Users` æ˜¯ firmlinkï¼Œæ£€æŸ¥ `URLResourceKey.volumeIdentifierKey` é¿å…é‡å¤è®¡ç®—ã€‚
    *   å®ç° **ç¡¬é“¾æ¥/Clone å»é‡**ï¼šä½¿ç”¨ `URLResourceKey.fileResourceIdentifierKey` è¿½è¸ªå·²è®¿é—®çš„ inodeã€‚
    *   å®ç° **æ–‡ä»¶é”æ£€æµ‹**ï¼šå°è¯•è·å–æ–‡ä»¶é”æˆ–æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å…¶ä»–è¿›ç¨‹æ‰“å¼€ã€‚
    *   å®ç° **å¤–éƒ¨å·/ç½‘ç»œå·æ£€æµ‹**ï¼šæ£€æŸ¥ `URLResourceKey.volumeIsLocalKey`ï¼Œéæœ¬åœ°å·ç‰¹æ®Šå¤„ç†ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   åˆ›å»ºä¸€ä¸ªåŒ…å« Symlink æŒ‡å‘ `/etc` çš„æµ‹è¯•æ–‡ä»¶å¤¹ï¼Œè¿è¡Œæ‰«æå™¨ï¼Œç¡®ä¿æ²¡æœ‰æ‰«æåˆ° `/etc` å†…éƒ¨æ–‡ä»¶ã€‚
    *   åˆ›å»ºä¸€ä¸ª iCloud å ä½æ–‡ä»¶ï¼Œç¡®ä¿æ‰«æå™¨å°†å…¶æ ‡è®°ä¸º"å¿½ç•¥"æˆ–ä¸è®¡ç®—åœ¨æ¸…ç†å¤§å°ä¸­ã€‚
    *   åœ¨å¤–éƒ¨ USB é©±åŠ¨å™¨ä¸Šåˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼Œç¡®è®¤æ‰«æå™¨èƒ½æ­£ç¡®è¯†åˆ«å·ç±»å‹ã€‚
*   **æµ‹è¯•è®¡åˆ’**ï¼š
    *   å•å…ƒæµ‹è¯• (`ScannerTests.swift`)ï¼š
        *   å¾ªç¯ Symlink æµ‹è¯•
        *   æ–­é“¾ Symlink æµ‹è¯•
        *   å—é™ç›®å½•æµ‹è¯•
        *   Firmlink é‡å¤è®¡ç®—æµ‹è¯•
        *   ç¡¬é“¾æ¥å»é‡æµ‹è¯•
        *   iCloud å ä½ç¬¦æµ‹è¯•

### æ­¥éª¤ 1.3: åŸºç¡€ UI æ¡†æ¶
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   æ­å»º `MainView`ï¼ŒåŒ…å« Sidebar (åˆ†ç±») å’Œ Content Area (æ–‡ä»¶åˆ—è¡¨)ã€‚
    *   å®ç° `DiskUsageHeaderView` æ˜¾ç¤ºç£ç›˜ç©ºé—´ï¼ˆä½¿ç”¨ `URL(fileURLWithPath: "/").resourceValues(forKeys: [.volumeAvailableCapacityKey])`ï¼‰ã€‚
    *   é›†æˆ MVVM æ¶æ„ï¼Œç»‘å®šæ‰«æçŠ¶æ€ã€‚
    *   **UI æ€§èƒ½ä¼˜åŒ– (å…³é”®)**ï¼šå®ç° `BatchUpdater`ã€‚æ‰«æå™¨åœ¨åå°çº¿ç¨‹è¿è¡Œï¼Œä¸è¦æ¯å‘ç°ä¸€ä¸ªæ–‡ä»¶å°±åˆ·æ–° UIã€‚å°†æ›´æ–°èšåˆå¹¶**æ¯ 0.5 ç§’**æˆ–**æ¯ 100 ä¸ªé¡¹ç›®**åœ¨ MainActor ä¸Šå‘å¸ƒä¸€æ¬¡ï¼Œé˜²æ­¢ SwiftUI å¡æ­»ã€‚
    *   **æ‰«æå–æ¶ˆæœºåˆ¶**ï¼š
        *   ä½¿ç”¨ Swift Concurrency çš„ `Task`ï¼Œæ”¯æŒ `Task.checkCancellation()`ã€‚
        *   UI ä¸Šæä¾›ã€Œå–æ¶ˆæ‰«æã€æŒ‰é’®ã€‚
    *   **æ‰«æè¿›åº¦ä¼°ç®—**ï¼š
        *   å…ˆå¿«é€Ÿç»Ÿè®¡ç›®æ ‡ç›®å½•çš„æ–‡ä»¶æ€»æ•°ï¼ˆä½¿ç”¨ `enumerator.skipDescendants` ç²—ç•¥ä¼°ç®—ï¼‰ã€‚
        *   æ˜¾ç¤ºç™¾åˆ†æ¯”è¿›åº¦æ¡å’Œå·²æ‰«ææ–‡ä»¶æ•°ã€‚
    *   **å†…å­˜ç®¡ç†ç­–ç•¥**ï¼š
        *   ä½¿ç”¨æ‡’åŠ è½½çš„ tree ç»“æ„è€Œéæ‰å¹³æ•°ç»„å­˜å‚¨æ‰«æç»“æœã€‚
        *   åªä¿ç•™å¿…è¦å­—æ®µï¼ˆè·¯å¾„ã€å¤§å°ã€ç±»å‹ï¼‰ï¼Œè¯¦æƒ…æŒ‰éœ€åŠ è½½ã€‚
        *   å¯¹äºè¶…å¤§ç›®å½•ï¼ˆ>10 ä¸‡é¡¹ï¼‰ï¼Œè€ƒè™‘ SQLite æŒä¹…åŒ–ã€‚
    *   **Accessibility æ”¯æŒ**ï¼šä¸ºæ‰€æœ‰å¯äº¤äº’å…ƒç´ æ·»åŠ  `accessibilityLabel`ã€‚
    *   **æœ¬åœ°åŒ–å‡†å¤‡**ï¼šä½¿ç”¨ String Catalogsï¼ˆ.xcstringsï¼‰æ”¯æŒä¸­è‹±æ–‡åˆ‡æ¢ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   è¿è¡Œ Appï¼Œç•Œé¢å¸ƒå±€ç¬¦åˆé¢„æœŸï¼Œç£ç›˜å®¹é‡æ˜¾ç¤ºæ­£ç¡®ã€‚
    *   **å‹åŠ›æµ‹è¯•**ï¼šæ‰«æåŒ…å« 10 ä¸‡ä¸ªæ–‡ä»¶çš„ç›®å½•ï¼Œç¡®ä¿ UI ä¾ç„¶æµç•…å¯å“åº”ï¼ˆä¸è½¬å½©è™¹åœˆï¼‰ã€‚
    *   æµ‹è¯•å–æ¶ˆæŒ‰é’®ï¼Œç¡®ä¿æ‰«æèƒ½ç«‹å³åœæ­¢ã€‚
*   **æµ‹è¯•è®¡åˆ’**ï¼š
    *   æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼šæ‰«æ 10 ä¸‡æ–‡ä»¶ < 30 ç§’ã€‚
    *   UI å“åº”æµ‹è¯•ï¼šåˆ—è¡¨æ»šåŠ¨ä¿æŒ 60 fpsã€‚

---

## ğŸ§  Phase 2: æ™ºèƒ½æ ¸å¿ƒä¸è§„åˆ™å¼•æ“ (Week 2)

**ç›®æ ‡**ï¼šè®© App èƒ½å¤Ÿè¯†åˆ«ä»€ä¹ˆæ˜¯åƒåœ¾æ–‡ä»¶ï¼Œå¹¶å…·å¤‡ AI åˆ†æèƒ½åŠ›ã€‚

### æ­¥éª¤ 2.1: ç§»æ¤è§„åˆ™å¼•æ“ (Rule Engine)
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   å®šä¹‰ `CleanupRule` ç»“æ„ä½“ (Swift)ï¼ŒåŒ…å«ä¼˜å…ˆçº§å­—æ®µï¼š
    ```swift
    struct CleanupRule: Identifiable {
        let id: String
        let name: String
        let pattern: String  // Regex æˆ– Glob
        let riskLevel: RiskLevel
        let priority: Int    // ä¼˜å…ˆçº§ï¼šæ•°å€¼è¶Šå¤§è¶Šä¼˜å…ˆ
        let isUserDefined: Bool
    }
    ```
    *   **è§„åˆ™ä¼˜å…ˆçº§ç³»ç»Ÿ**ï¼šç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ > å†…ç½®å®‰å…¨è§„åˆ™ > é€šç”¨è§„åˆ™ã€‚å¤šè§„åˆ™åŒ¹é…æ—¶å–æœ€é«˜ä¼˜å…ˆçº§ã€‚
    *   å°† Mole é¡¹ç›®çš„ Shell/Regex è§„åˆ™è½¬æ¢ä¸º Swift ä»£ç ã€‚
    *   å®ç° `RuleMatcher`ï¼Œæ¥å— `FileMetadata`ï¼Œè¿”å› `RiskLevel` å’ŒåŒ¹é…çš„è§„åˆ™ã€‚
    *   å®ç°æ ¸å¿ƒè§„åˆ™åº“ï¼šXcode DerivedData, node_modules, Python venv, Cachesã€‚
    *   **é¡¹ç›®æ´»è·ƒåº¦æ£€æµ‹**ï¼š
        *   å¯¹äº `node_modules`ã€`DerivedData` ç­‰å¼€å‘ç¼“å­˜ï¼Œæ£€æŸ¥é¡¹ç›®æ´»è·ƒåº¦ã€‚
        *   æ£€æµ‹æŒ‡æ ‡ï¼š`.git/logs/HEAD` æœ€åä¿®æ”¹æ—¶é—´ã€`package-lock.json` æ—¶é—´æˆ³ã€‚
        *   è¶…è¿‡ N å¤©ï¼ˆé»˜è®¤ 30 å¤©ï¼‰æœªæ´»è·ƒæ‰æ ‡è®°ä¸ºå¯æ¸…ç†ã€‚
    *   **ç”¨æˆ·è‡ªå®šä¹‰ç™½åå•/é»‘åå•**ï¼š
        *   åœ¨ Settings ä¸­å…è®¸ç”¨æˆ·æ·»åŠ ã€Œæ°¸ä¸æ‰«æã€è·¯å¾„æ¨¡å¼ã€‚
        *   å…è®¸ç”¨æˆ·æ·»åŠ ã€Œæ€»æ˜¯æ ‡è®°ä¸ºå¯æ¸…ç†ã€è·¯å¾„æ¨¡å¼ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   åœ¨çœŸå®é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œï¼Œæ£€æŸ¥æ˜¯å¦èƒ½æ­£ç¡®è¯†åˆ« `node_modules` å’Œ `DerivedData`ã€‚
    *   æµ‹è¯•æ´»è·ƒé¡¹ç›®çš„ `node_modules` ä¸è¢«æ ‡è®°ä¸ºé«˜ä¼˜å…ˆæ¸…ç†ã€‚
*   **æµ‹è¯•è®¡åˆ’**ï¼š
    *   å•å…ƒæµ‹è¯• (`RuleTests.swift`)ï¼šé’ˆå¯¹æ¯æ¡è§„åˆ™ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿è·¯å¾„åŒ¹é…é€»è¾‘ï¼ˆRegex/Globï¼‰å‡†ç¡®æ— è¯¯ã€‚
    *   æµ‹è¯•è§„åˆ™ä¼˜å…ˆçº§è¦†ç›–é€»è¾‘ã€‚

### æ­¥éª¤ 2.2: Prompt ç®¡ç†ç³»ç»Ÿ (Prompt Manager)
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   å®šä¹‰ `AnalysisContext` å’Œ `PromptTemplate` åè®®ã€‚
    *   å®ç° `PromptManager`ï¼Œæ ¹æ®æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¤§å°ã€ç±»å‹ã€è·¯å¾„ç‰¹å¾ï¼‰é€‰æ‹©æ¨¡æ¿ã€‚
    *   å®ç° `LargeDirectoryTemplate`, `AppSupportTemplate`, `CacheTemplate`ã€‚
    *   **å®Œæ•´çš„éšç§è„±æ•**ï¼šå®ç° `PathSanitizer`ï¼š
        *   `/Users/xxx` -> `~`
        *   `/Volumes/Macintosh HD` -> `/Volumes/[SystemVolume]`
        *   UUID æ ¼å¼ `xxx-xxxx-xxxx-xxxx` -> `[UUID]`
        *   æœºå™¨åºåˆ—å· -> `[SERIAL]`
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   è¾“å…¥ä¸€ä¸ªæ¨¡æ‹Ÿçš„ Contextï¼Œæ‰“å°ç”Ÿæˆçš„ Promptï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œé€»è¾‘æ˜¯å¦é€šé¡ºã€‚
*   **æµ‹è¯•è®¡åˆ’**ï¼š
    *   å•å…ƒæµ‹è¯•ï¼šéªŒè¯ `PathSanitizer` å¯¹å„ç§è·¯å¾„çš„è„±æ•æ•ˆæœã€‚
    *   å•å…ƒæµ‹è¯•ï¼šéªŒè¯ `PromptManager` æ˜¯å¦èƒ½ä¸ºä¸åŒæ–‡ä»¶ç±»å‹é€‰æ‹©æ­£ç¡®çš„ Prompt æ¨¡æ¿ã€‚

### æ­¥éª¤ 2.3: LLM å®¢æˆ·ç«¯ä¸å¹¶å‘æ§åˆ¶
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   å®ç° `LLMClient`ï¼Œæ”¯æŒ OpenAI æ ¼å¼æ¥å£ï¼ˆå…¼å®¹ Groq, Qianwenï¼‰ã€‚
    *   å®ç° `KeychainManager` å®‰å…¨å­˜å– API Keyã€‚
    *   å®ç° `AIRequestQueue` (Actoræ¨¡å‹)ï¼Œé™åˆ¶æœ€å¤§å¹¶å‘æ•°ä¸º 3ã€‚
    *   å®ç° `SettingsView` ä¸­çš„ API Key é…ç½®ç•Œé¢ã€‚
    *   **LLM å“åº”è§£æå®¹é”™**ï¼š
        *   JSON è§£æå¤±è´¥æ—¶ï¼Œé‡è¯• 1 æ¬¡ï¼ˆå¸¦ retry prompt æç¤ºæ¨¡å‹ä¿®æ­£æ ¼å¼ï¼‰ã€‚
        *   ä»å¤±è´¥åˆ™é™çº§ä¸ºã€Œæ— æ³•åˆ†æã€çŠ¶æ€ï¼Œä¸é˜»å¡æµç¨‹ã€‚
    *   **å“åº”ç¼“å­˜**ï¼š
        *   å¯¹ç›¸åŒè·¯å¾„æ¨¡å¼ï¼ˆå¦‚ `~/Library/Caches/{app}/fsCachedData`ï¼‰çš„åˆ†æç»“æœç¼“å­˜ 24 å°æ—¶ã€‚
        *   ä½¿ç”¨è·¯å¾„çš„ Glob æ¨¡å¼ä½œä¸ºç¼“å­˜ keyï¼Œè€Œéç²¾ç¡®è·¯å¾„ã€‚
    *   **ç¦»çº¿æ¨¡å¼**ï¼šæ— ç½‘ç»œæˆ–æ—  API Key æ—¶ï¼Œè§„åˆ™å¼•æ“ç‹¬ç«‹å·¥ä½œï¼ŒAI åˆ†ææ ‡è®°ä¸ºã€Œä¸å¯ç”¨ã€ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   é…ç½® Groq API Keyï¼Œå‘èµ·ä¸€æ¬¡çœŸå®è¯·æ±‚ï¼Œæ£€æŸ¥å“åº”é€Ÿåº¦å’Œ JSON è§£ææ˜¯å¦æ­£ç¡®ã€‚
    *   å¿«é€Ÿè¿ç»­å‘èµ· 10 æ¬¡è¯·æ±‚ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ 3 ä¸ªåœ¨æ‰§è¡Œã€‚
    *   æµ‹è¯• JSON æ ¼å¼é”™è¯¯çš„å“åº”ï¼Œç¡®è®¤é‡è¯•å’Œé™çº§é€»è¾‘æ­£å¸¸ã€‚

---

## ğŸ›¡ï¸ Phase 3: æ•´åˆã€å®‰å…¨é˜²æŠ¤ä¸äº¤ä»˜ (Week 3)

**ç›®æ ‡**ï¼šå°†æ‰€æœ‰æ¨¡å—ç»„è£…ï¼Œæ·»åŠ å®‰å…¨ç½‘ï¼Œå‡†å¤‡å‘å¸ƒã€‚

### æ­¥éª¤ 3.1: æ•´åˆæ‰«æä¸å†³ç­–æµç¨‹
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   åœ¨ `DiskCleanerViewModel` ä¸­ä¸²è”æµç¨‹ï¼šæ‰«æ -> è§„åˆ™åŒ¹é… -> (é«˜é£é™©é¡¹) -> AI åˆ†æ -> ç»“æœåˆ—è¡¨ã€‚
    *   å®ç°ç»“æœæ’åºï¼šä¼˜å…ˆæ˜¾ç¤ºä½é£é™©ã€å¤§ä½“ç§¯çš„é¡¹ç›®ã€‚
    *   UI å±•ç¤ºï¼šæ˜ç¡®åŒºåˆ†"è§„åˆ™åˆ¤å®š"å’Œ"AI å»ºè®®"çš„é¡¹ç›®ã€‚
    *   **æˆæœ¬æ§åˆ¶**ï¼šé»˜è®¤**ä¸è‡ªåŠ¨åˆ†æ**æ‰€æœ‰é«˜é£é™©é¡¹ç›®ã€‚UI ä¸Šæä¾›"åˆ†æå‰ 10 é¡¹"æˆ–"åˆ†æé€‰ä¸­é¡¹"æŒ‰é’®ï¼Œé¿å…ç”¨æˆ·æ— æ„ä¸­æ¶ˆè€—å¤§é‡ Tokenã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   å…¨æµç¨‹è·‘é€šï¼šä»ç‚¹å‡»æ‰«æåˆ°å±•ç¤ºå‡ºå¸¦æœ‰ AI å»ºè®®çš„æ¸…ç†åˆ—è¡¨ã€‚

### æ­¥éª¤ 3.2: Dry Run ä¸æ‰§è¡Œä¿æŠ¤
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   å®ç° `TrashManager`ï¼šæ‰€æœ‰åˆ é™¤æ“ä½œç»Ÿä¸€è°ƒç”¨ `FileManager.default.trashItem(at:resultItemURL:)` (è½¯åˆ é™¤)ã€‚
    *   **å¤–éƒ¨å·/ç½‘ç»œå·å¤„ç†**ï¼š
        *   æ£€æµ‹ `URLResourceKey.volumeIsLocalKey`ã€‚
        *   éæœ¬åœ°å·ä¸Š `trashItem()` å¯èƒ½å¤±è´¥ï¼Œåº”æç¤ºç”¨æˆ·æˆ–æ‹’ç»åˆ é™¤ã€‚
    *   å®ç° **Dry Run æ¨¡å¼**ï¼šæ¨¡æ‹Ÿåˆ é™¤è¿‡ç¨‹ï¼Œä»…æ‰“å°æ—¥å¿—ï¼Œä¸å®é™…æ“ä½œæ–‡ä»¶ç³»ç»Ÿã€‚
    *   å®ç° **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ¯æ¬¡æ¸…ç†æ“ä½œçš„æ—¶é—´ã€è·¯å¾„ã€å¤§å°ã€å†³ç­–æ¥æºï¼ˆè§„åˆ™/AIï¼‰ã€‚
    *   å®ç° **æ’¤é”€åŠŸèƒ½**ï¼š
        *   æ¸…ç†åä¿å­˜åˆ é™¤è®°å½•åˆ° SQLiteï¼ˆåŸè·¯å¾„ã€åºŸçº¸ç¯“è·¯å¾„ã€æ—¶é—´æˆ³ï¼‰ã€‚
        *   æä¾›ã€Œæ¢å¤ä¸Šæ¬¡æ¸…ç†çš„æ–‡ä»¶ã€åŠŸèƒ½ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   å¼€å¯ Dry Runï¼Œç‚¹å‡»æ¸…ç†ï¼Œæ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤æ–‡ä»¶æœªè¢«ç§»åŠ¨ã€‚
    *   å…³é—­ Dry Runï¼Œç‚¹å‡»æ¸…ç†ï¼Œç¡®è®¤æ–‡ä»¶è¢«ç§»åŠ¨åˆ°åºŸçº¸ç¯“ï¼Œä¸”å¯ä»¥"æ”¾å›åŸå¤„"ã€‚
    *   æµ‹è¯•å¤–éƒ¨ USB é©±åŠ¨å™¨ä¸Šçš„æ–‡ä»¶åˆ é™¤è¡Œä¸ºã€‚

### æ­¥éª¤ 3.3: Sparkle è‡ªåŠ¨æ›´æ–°é›†æˆ
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   é›†æˆ `Sparkle` Framework (SPM æˆ– XCFramework)ã€‚
    *   é…ç½® `SUFeedURL` åˆ° `Info.plist`ã€‚
    *   ç”Ÿæˆ EdDSA ç­¾åå¯†é’¥ã€‚
    *   åœ¨ UI ä¸­æ·»åŠ "æ£€æŸ¥æ›´æ–°"èœå•é¡¹ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   æ­å»ºæœ¬åœ° HTTP æœåŠ¡å™¨æ‰˜ç®¡ `appcast.xml`ï¼ŒéªŒè¯ App èƒ½å¦æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ã€‚

### æ­¥éª¤ 3.4: CI/CD ä¸ DMG æ‰“åŒ…
*   **å¼€å‘è®¡åˆ’**ï¼š
    *   åˆ›å»º GitHub Actions workflowï¼š
        *   è‡ªåŠ¨æ„å»º + å•å…ƒæµ‹è¯• (`xcodebuild test`)
        *   è‡ªåŠ¨ç­¾å + å…¬è¯ (`xcrun notarytool submit`)
        *   è‡ªåŠ¨ç”Ÿæˆ DMG (`create-dmg` æˆ– `appdmg`)
        *   è‡ªåŠ¨æ›´æ–° `appcast.xml`
    *   é…ç½® GitHub Secrets å­˜å‚¨ç­¾åè¯ä¹¦å’Œ API å¯†é’¥ã€‚
    *   å®ç°ç‰ˆæœ¬å·è‡ªåŠ¨é€’å¢ï¼ˆåŸºäº git tagï¼‰ã€‚
*   **éªŒè¯è®¡åˆ’**ï¼š
    *   Push ä»£ç åï¼ŒGitHub Actions è‡ªåŠ¨æ„å»ºå¹¶ç”Ÿæˆå…¬è¯åçš„ DMGã€‚
    *   ä¸‹è½½ DMG å®‰è£…ï¼Œç¡®è®¤ç­¾åå’Œå…¬è¯çŠ¶æ€æ­£ç¡®ã€‚

### æ­¥éª¤ 3.5: æœ€ç»ˆéªŒæ”¶æµ‹è¯• (User Acceptance Testing)
*   **æµ‹è¯•è®¡åˆ’**ï¼š
    *   **å…¨æ–°å®‰è£…æµ‹è¯•**ï¼šåœ¨å¹²å‡€çš„è™šæ‹Ÿæœºä¸­å®‰è£…ï¼Œæ£€æŸ¥æƒé™å¼•å¯¼æµç¨‹ã€‚
    *   **ç ´åæ€§æµ‹è¯•**ï¼šåœ¨åŒ…å«æ–­é“¾ Symlinkã€é”æ­»æ–‡ä»¶ã€iCloud å ä½æ–‡ä»¶çš„ç›®å½•ä¸‹è¿è¡Œã€‚
    *   **ç½‘ç»œå¼‚å¸¸æµ‹è¯•**ï¼šæ–­ç½‘æƒ…å†µä¸‹ï¼ŒAI åŠŸèƒ½åº”ä¼˜é›…é™çº§ï¼ˆæç¤ºç½‘ç»œé”™è¯¯æˆ–è·³è¿‡ï¼‰ã€‚
    *   **éšç§æµ‹è¯•**ï¼šæŠ“åŒ…æ£€æŸ¥å‘å¾€ LLM çš„è¯·æ±‚ï¼Œç¡®ä¿æ²¡æœ‰æ˜æ–‡ç»å¯¹è·¯å¾„ã€ç”¨æˆ·åã€æœºå™¨åã€‚
    *   **UI æµ‹è¯•**ï¼šä½¿ç”¨ XCUITest è¦†ç›–æ ¸å¿ƒæµç¨‹ï¼ˆå¯åŠ¨ -> æˆæƒå¼•å¯¼ -> æ‰«æ -> é€‰ä¸­ -> æ¸…ç†ï¼‰ã€‚
    *   **æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šä½¿ç”¨ XCTest `measure {}` å—éªŒè¯æ€§èƒ½æŒ‡æ ‡ã€‚
    *   **å†…å­˜æ³„æ¼æµ‹è¯•**ï¼šä½¿ç”¨ Instruments Leaks æ¨¡æ¿æ£€æŸ¥ã€‚
    *   **Accessibility æµ‹è¯•**ï¼šå¯ç”¨ VoiceOverï¼ŒéªŒè¯æ‰€æœ‰åŠŸèƒ½å¯è®¿é—®ã€‚

---

## ğŸ“‚ äº¤ä»˜äº§ç‰©æ¸…å•

1.  **Source Code**: å®Œæ•´çš„ Xcode å·¥ç¨‹ã€‚
2.  **App Bundle**: å·²ç­¾åå¹¶å…¬è¯çš„ `.app` æ–‡ä»¶ (macOS 12+)ã€‚
3.  **DMG Installer**: å¸¦èƒŒæ™¯å›¾çš„ DMG å®‰è£…åŒ…ã€‚
4.  **Docs**: æ›´æ–°åçš„ README, ç”¨æˆ·æ‰‹å†Œã€‚
5.  **Distribution**: `appcast.xml` å’Œæ›´æ–°æœåŠ¡å™¨é…ç½®æŒ‡å—ã€‚
6.  **CI/CD**: GitHub Actions workflow é…ç½®ã€‚

---

## âš ï¸ é£é™©ç®¡ç† (Risk Management)

| é£é™©ç‚¹ | åº”å¯¹æªæ–½ |
| :--- | :--- |
| **è¯¯åˆ å…³é”®æ–‡ä»¶** | é»˜è®¤ä»…ç§»åŠ¨åˆ°åºŸçº¸ç¯“ï¼›å®Œæ•´çš„ç³»ç»Ÿç›®å½•é»‘åå•ï¼ˆå« Firmlinkã€Time Machineï¼‰ï¼›AI å»ºè®®ä»…ä¾›å‚è€ƒï¼Œå¿…é¡»ç”¨æˆ·ç¡®è®¤ï¼›æä¾›æ’¤é”€åŠŸèƒ½ã€‚ |
| **AI äº§ç”Ÿå¹»è§‰** | Prompt ä¸­å¼ºåˆ¶è¦æ±‚ JSON æ ¼å¼å¹¶è§£é‡ŠåŸå› ï¼›è§£æå¤±è´¥æ—¶é‡è¯•+é™çº§ï¼›UI ä¸Šæ˜¾è‘—æ ‡è¯† AI çš„ç½®ä¿¡åº¦å’Œã€ŒAI åˆ†æä»…ä¾›å‚è€ƒã€è­¦å‘Šã€‚ |
| **API è´¹ç”¨è¶…æ”¯** | è®¾ç½®æ¯æ—¥ Token ä¸Šé™ï¼ˆå®¢æˆ·ç«¯è®¡æ•°ï¼‰ï¼›é»˜è®¤æ¨èå…è´¹/ä½ä»·æ¨¡å‹ (Groq)ï¼›å“åº”ç¼“å­˜å‡å°‘é‡å¤è¯·æ±‚ã€‚ |
| **Apple å…¬è¯å¤±è´¥** | å¯ç”¨ Hardened Runtimeï¼›æå‰æ£€æŸ¥ entitlements é…ç½®ï¼›æ·»åŠ  Privacy Manifestï¼›ç¡®ä¿æ²¡æœ‰ä½¿ç”¨ç§æœ‰ APIï¼›CI ä¸­è‡ªåŠ¨åŒ–å…¬è¯æµç¨‹ã€‚ |
| **æ‰«ææ€§èƒ½é—®é¢˜** | BatchUpdater èšåˆ UI æ›´æ–°ï¼›å†…å­˜ç®¡ç†ç­–ç•¥ï¼ˆæ‡’åŠ è½½/SQLiteï¼‰ï¼›æä¾›å–æ¶ˆæœºåˆ¶ï¼›ç¡¬é“¾æ¥/Firmlink å»é‡é¿å…é‡å¤è®¡ç®—ã€‚ |
| **å¤–éƒ¨å·åˆ é™¤å¤±è´¥** | æ£€æµ‹å·ç±»å‹ï¼›éæœ¬åœ°å·ç¦ç”¨åˆ é™¤æˆ–æç¤ºç”¨æˆ·ï¼›ä¼˜é›…å¤„ç† `trashItem()` å¤±è´¥ã€‚ |
| **æƒé™è¢«æ’¤é”€** | æ¯æ¬¡æ‰«æå‰é‡æ–°æ£€æŸ¥ FDA æƒé™ï¼›æƒé™ä¸¢å¤±æ—¶æ˜¾ç¤ºå¼•å¯¼é¡µè€Œéå´©æºƒã€‚ |
| **ç½‘ç»œä¸å¯ç”¨** | è§„åˆ™å¼•æ“ç‹¬ç«‹å·¥ä½œï¼›AI åŠŸèƒ½ä¼˜é›…é™çº§ï¼›ç¼“å­˜ä¹‹å‰çš„åˆ†æç»“æœã€‚ |

---

## ğŸ“‹ æŠ€æœ¯è§„æ ¼æ±‡æ€»

### ç³»ç»Ÿè¦æ±‚
- macOS 12.0+ (Monterey)
- Apple Silicon / Intel é€šç”¨äºŒè¿›åˆ¶

### å…³é”® URL Resource Keys
```swift
let requiredKeys: Set<URLResourceKey> = [
    .fileSizeKey,
    .isDirectoryKey,
    .isSymbolicLinkKey,
    .isUbiquitousItemKey,
    .ubiquitousItemDownloadingStatusKey,
    .volumeIdentifierKey,
    .volumeIsLocalKey,
    .fileResourceIdentifierKey,  // inode å»é‡
    .contentModificationDateKey
]
```

### FDA æ£€æµ‹è·¯å¾„
```swift
let fdaTestPaths = [
    "~/Library/Mail",
    "~/Library/Messages",
    "~/Library/Safari"
]
```

### ç³»ç»Ÿä¿æŠ¤è·¯å¾„
```swift
let protectedPaths: Set<String> = [
    "/System", "/usr", "/bin", "/sbin",
    "/private/var/db", "/Library/Apple",
    "/.Trashes", "/.Spotlight-V100", "/.fseventsd",
    "/Volumes/.timemachine"
]
```