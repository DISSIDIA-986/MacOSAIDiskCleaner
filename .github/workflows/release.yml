name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Show Runner Info
        run: |
          echo "Runner: ${{ runner.os }}"
          echo "Ref: ${{ github.ref }}"
          echo "Sha: ${{ github.sha }}"

      - name: Set Version from Tag
        run: |
          APP_VERSION=${GITHUB_REF#refs/tags/v}
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "Version: $APP_VERSION"

      - name: Install Dependencies
        run: |
          brew install create-dmg
          pip3 install --break-system-packages Pillow

      - name: Clone Sparkle
        run: |
          cd ..
          git clone --depth 1 --branch 2.6.4 https://github.com/sparkle-project/Sparkle.git Sparkle
          cd MacOSAIDiskCleaner
          mkdir -p Vendor
          cp -R ../Sparkle Vendor/Sparkle

      - name: Build Release
        run: |
          xcodebuild -scheme MacOSAIDiskCleaner \
            -configuration Release \
            -derivedDataPath ./build \
            MARKETING_VERSION=${{ env.APP_VERSION }} \
            CURRENT_PROJECT_VERSION=${{ github.run_number }} \
            clean build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ENABLE_APP_SANDBOX=NO

      - name: Verify Build
        run: |
          APP_PATH="./build/Build/Products/Release/MacOSAIDCleaner.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ Build failed"
            exit 1
          fi
          echo "âœ… Build successful"
          ls -lh "$APP_PATH"

      - name: Create DMG
        run: |
          mkdir -p dist
          create-dmg \
            --volname "MacOSAIDiskCleaner" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "MacOSAIDiskCleaner.app" 100 190 \
            --hide-extension "MacOSAIDiskCleaner.app" \
            --app-drop-link 450 190 \
            "dist/MacOSAIDiskCleaner_${{ env.APP_VERSION }}.dmg" \
            "./build/Build/Products/Release/MacOSAIDiskCleaner.app"

      - name: Create Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MacOSAIDiskCleaner ${{ env.APP_VERSION }}

          ðŸŽ‰ Major Release with Security Fixes and Improvements

          ## ðŸ”’ Security Fixes (P0)
          - **P0-2**: Path Traversal protection using canonicalPathKey
          - **P0-3**: Permission race condition prevention

          ## ðŸ› Bug Fixes (P1)
          - **P1-4**: LLM retry mechanism with exponential backoff
          - **P1-5**: AuditLog concurrent write safety
          - **P1-6**: GlobMatcher pattern complexity limits
          - **P1-7**: StatisticsManager memory leak prevention

          ## âœ… Improvements
          - 100% test pass rate (23/23 tests)
          - Fixed StatisticsManager test failures
          - Comprehensive documentation (README, insights report)
          - URL extensions for common operations
          - Improved logging and error tracking

          ## ðŸ“¦ Downloads
          **macOS 12.0+**: [DMG Installation](https://github.com/DISSIDIA-986/MacOSAIDiskCleaner/releases/download/v${{ env.APP_VERSION }}/MacOSAIDiskCleaner_${{ env.APP_VERSION }}.dmg)

          ## ðŸ” Verification
          **SHA256**: \`$(shasum -a 256 dist/*.dmg | awk '{print $1}')\`

          ---
          **Full Changelog**: https://github.com/DISSIDIA-986/MacOSAIDiskCleaner/compare/v0.1.5...v${{ env.APP_VERSION }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.dmg
          body_path: RELEASE_NOTES.md
          generate_release_notes: false
          draft: false
          prerelease: false
          name: ${{ env.APP_VERSION }}
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/*.dmg
            RELEASE_NOTES.md
          retention-days: 30
