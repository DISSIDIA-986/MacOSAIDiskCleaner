name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Install Dependencies
        run: |
          brew install create-dmg
          pip3 install --break-system-packages Pillow

      - name: Clone Sparkle
        run: |
          cd ..
          git clone --depth 1 --branch 2.6.4 https://github.com/sparkle-project/Sparkle.git Sparkle
          cd MacOSAIDiskCleaner
          mkdir -p Vendor
          cp -R ../Sparkle Vendor/Sparkle

      - name: Set Version from Tag
        run: echo "APP_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build Release
        run: |
          xcodebuild -scheme MacOSAIDiskCleaner \
            -configuration Release \
            -derivedDataPath ./build \
            MARKETING_VERSION=${{ env.APP_VERSION }} \
            CURRENT_PROJECT_VERSION=${{ github.run_number }} \
            clean build \
            CODE_SIGN_IDENTITY="${{ secrets.APPLE_SIGNING_IDENTITY }}" \
            CODE_SIGNING_REQUIRED=${{ secrets.APPLE_SIGNING_IDENTITY != '' }} \
            CODE_SIGNING_ALLOWED=YES \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" || echo "Build completed with warnings"

      - name: Verify Build Output
        run: |
          APP_PATH="./build/Build/Products/Release/MacOSAIDiskCleaner.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ Build failed: MacOSAIDiskCleaner.app not found"
            exit 1
          fi
          echo "âœ… Build successful"
          ls -lh "$APP_PATH"

      - name: Create DMG
        run: |
          mkdir -p dist
          create-dmg \
            --volname "MacOSAIDiskCleaner" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "MacOSAIDiskCleaner.app" 100 190 \
            --hide-extension "MacOSAIDiskCleaner.app" \
            --app-drop-link 450 190 \
            "dist/MacOSAIDiskCleaner_${{ env.APP_VERSION }}.dmg" \
            "./build/Build/Products/Release/MacOSAIDiskCleaner.app"

      - name: Setup Sparkle Tools
        run: |
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz -o sparkle.tar.xz
          tar -xf sparkle.tar.xz bin/generate_appcast

      - name: Generate Appcast
        if: secrets.SPARKLE_PRIVATE_KEY != ''
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo "$SPARKLE_PRIVATE_KEY" > sparkle_key.txt
          ./bin/generate_appcast --ed-key-file sparkle_key.txt dist/
          rm sparkle_key.txt

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # MacOSAIDiskCleaner ${{ env.APP_VERSION }}

          ## ðŸŽ‰ Release Highlights

          ### ðŸ”’ Security Fixes
          - P0-2: Path Traversal protection using canonicalPathKey
          - P0-3: Permission race condition prevention

          ### ðŸ› Bug Fixes
          - P1-4: LLM retry mechanism with exponential backoff
          - P1-5: AuditLog concurrent write safety
          - P1-6: GlobMatcher pattern complexity limits
          - P1-7: StatisticsManager memory leak prevention

          ### âœ… Testing
          - 100% test pass rate (23/23 tests)
          - Fixed StatisticsManager test failures

          ### ðŸ“ Documentation
          - Comprehensive README.md
          - Project insights report
          - Security fixes documentation

          ## ðŸ“¦ Downloads

          **macOS 12.0+**: [MacOSAIDiskCleaner_${{ env.APP_VERSION }}.dmg](https://github.com/DISSIDIA-986/MacOSAIDiskCleaner/releases/download/v${{ env.APP_VERSION }}/MacOSAIDiskCleaner_${{ env.APP_VERSION }}.dmg)

          ## ðŸ” Verification

          **SHA256**: \`$(shasum -a 256 dist/MacOSAIDiskCleaner_${{ env.APP_VERSION }}.dmg | awk '{print $1}')\`

          ---

          **Full Changelog**: https://github.com/DISSIDIA-986/MacOSAIDiskCleaner/compare/v0.1.5...v${{ env.APP_VERSION }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/appcast.xml
          body_path: RELEASE_NOTES.md
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/*.dmg
            dist/appcast.xml
          retention-days: 30
