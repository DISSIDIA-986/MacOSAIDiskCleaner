name: Release and Appcast

on:
  push:
    tags:
      - 'v*' # 当推送 v0.1.0 等标签时触发

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Install Python Dependencies
        run: pip3 install Pillow

      - name: Clone Sparkle (Fix Paths)
        run: |
          # 策略：在所有可能的路径都准备好代码
          
          # 1. 官方推荐的 Vendor 路径
          mkdir -p Vendor
          git clone --depth 1 --branch 2.6.4 https://github.com/sparkle-project/Sparkle.git Vendor/Sparkle
          
          # 2. 根目录路径 (Xcode 报错指向这里)
          cp -r Vendor/Sparkle Sparkle

      - name: Set Version from Tag
        run: echo "APP_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build App
        run: |
          xcodebuild -scheme MacOSAIDiskCleaner \
            -configuration Release \
            -derivedDataPath ./build \
            clean build \
            CODE_SIGNING_ALLOWED=NO

      - name: Create DMG
        run: |
          mkdir -p dist
          # 使用 Python 脚本重新生成背景图（CI 环境没有文件）
          python3 generate_bg.py
          create-dmg \
            --volname "MacOSAIDiskCleaner" \
            --background "dmg_background.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "MacOSAIDiskCleaner.app" 100 190 \
            --hide-extension "MacOSAIDiskCleaner.app" \
            --app-drop-link 450 190 \
            "dist/MacOSAIDiskCleaner_${{ env.APP_VERSION }}.dmg" \
            "./build/Build/Products/Release/MacOSAIDiskCleaner.app"

      - name: Setup Sparkle Binary
        run: |
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz -o sparkle.tar.xz
          tar -xf sparkle.tar.xz bin/generate_appcast

      - name: Generate Appcast
        env:
          # 需要在 GitHub Secrets 中配置此私钥
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # 将私钥从 Secret 写入临时文件供 Sparkle 使用
          echo "$SPARKLE_PRIVATE_KEY" > sparkle_key.txt
          ./bin/generate_appcast --edkey-path sparkle_key.txt dist/
          rm sparkle_key.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/appcast.xml
          body: "MacOS AI Disk Cleaner Release ${{ env.APP_VERSION }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}